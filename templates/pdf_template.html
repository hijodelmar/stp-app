<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>{{ document.numero }}</title>
    <style>
        @page {
            size: a4 portrait;
            margin: 1cm;

            /* CADRE EN-TÊTE */
            @frame header_frame {
                -pdf-frame-content: header_content;
                left: 1cm;
                width: 19cm;
                top: 1cm;
                height: 5cm;
            }

            /* CADRE CONTENU */
            @frame content_frame {
                left: 1cm;
                width: 19cm;
                top: 6cm;
                height: 21cm;
            }

            /* CADRE PIED DE PAGE */
            @frame footer_frame {
                -pdf-frame-content: footer_content;
                left: 1cm;
                width: 19cm;
                top: 27.5cm;
                height: 1.5cm;
            }
        }

        body {
            font-family: Helvetica, Arial, sans-serif;
            font-size: 12px;
            color: #000;
        }

        /* Layout Tables */
        table.header-table {
            width: 100%;
            border: none;
        }

        table.header-table td {
            vertical-align: top;
        }

        .company-title {
            font-size: 24px;
            font-weight: bold;
            color: #000;
            text-align: center;
            margin-bottom: 5px;
        }

        .company-details {
            font-size: 11px;
            color: #000;
            text-align: center;
            line-height: 1.4;
        }

        /* Meta Info Table */
        table.meta-table {
            width: 100%;
            border: none;
            border-collapse: collapse;
            margin-bottom: 5px;
        }

        table.meta-table td {
            vertical-align: top;
            padding: 0;
        }

        .doc-title {
            font-size: 16px;
            font-weight: bold;
            color: #000;
        }

        .client-box {
            text-align: right;
            /* Changed to right */
            margin-left: auto;
            width: 250px;
        }

        .city-date {
            text-align: right;
            margin-top: 30px;
            font-size: 12px;
            color: #000;
        }

        /* Items Table */
        table.items-table {
            width: 100%;
            border-collapse: collapse;
        }

        table.items-table th {
            border-bottom: 2px solid #000;
            color: #000;
            text-align: left;
            padding: 8px;
            font-weight: bold;
            font-size: 11px;
        }

        table.items-table td {
            border-bottom: 1px solid #000;
            padding: 8px;
            font-size: 11px;
            color: #000;
        }

        .totals {
            margin-top: 30px;
            float: right;
            width: 40%;
        }

        .totals-row {
            margin-bottom: 5px;
            font-size: 12px;
            color: #000;
        }

        .totals-row.grand-total {
            font-weight: bold;
            font-size: 14px;
            border-top: 2px solid #000;
            padding-top: 10px;
            color: #000;
        }

        .footer {
            text-align: center;
            font-size: 9px;
            color: #000;
            border-top: 1px solid #000;
            padding-top: 8px;
            line-height: 1.3;
        }

        .bordered-box {
            border: 1px solid #000;
            padding: 5px 10px;
            margin-bottom: 5px;
            font-size: 10px;
            color: #000;
            background-color: #fff;
        }
    </style>
</head>

<body>
    <!-- HEADER CONTENT -->
    <div id="header_content">
        <table class="header-table">
            <tr>
                <td style="width: 30%;">
                    {% if info and info.logo_path %}
                    <img src="{{ logo_abs_path }}" width="150" style="width: 150px; height: auto;">
                    {% endif %}
                </td>
                <td style="width: 70%; text-align: center;">
                    <div class="company-title">{{ info.nom if info else 'STP' }}</div>
                    <div class="company-details">
                        {{ info.adresse if info else '' }}<br>
                        {{ info.cp if info else '' }} {{ info.ville if info else '' }}<br>
                        Tél: {{ info.telephone if info else '' }}<br>
                        Email: {{ info.email if info else '' }}
                    </div>
                </td>
            </tr>
        </table>
    </div>

    <!-- FOOTER CONTENT -->
    <div id="footer_content">
        <div class="footer">
            {% if info and info.footer_info %}
            {{ info.footer_info|replace('\n', '<br>')|safe }}
            {% else %}
            <strong style="color: #000;">{{ info.nom if info else 'STP' }}</strong>
            - {{ info.adresse if info else '' }} {{ info.cp if info else '' }} {{ info.ville if info else '' }}<br>
            {% if info.siret %}SIRET : {{ info.siret }} &nbsp; - &nbsp;{% endif %}
            {% if info.telephone %}Tél : {{ info.telephone }} &nbsp; - &nbsp;{% endif %}
            {% if info.email %}Email : {{ info.email }}{% endif %}
            {% endif %}
        </div>
    </div>

    <!-- MAIN TEMPLATE CONTENT -->

    <!-- 1. Meta Info & Client -->
    <table class="meta-table">
        <!-- Row 1: Title -->
        <tr>
            <td style="width: 50%; padding-bottom: 5px;">
                <div class="doc-title">
                    {{ document.type|upper }} : N° {{ document.numero }}
                </div>
                {% if document.type == 'avoir' %}
                <div style="font-size: 10px; color: #000; margin-top: 2px;">
                    (Sur facture N° {{ document.source_document.numero if document.source_document else 'N/A' }})
                </div>
                {% endif %}
            </td>
            <td style="width: 50%;"></td>
        </tr>

        <!-- Row 2: Ref Client -->
        {% if document.client_reference and document.type != 'devis' %}
        <tr>
            <td style="width: 50%; padding-bottom: 5px;">
                <strong>Référence Client :</strong> {{ document.client_reference }}
            </td>
            <td style="width: 50%;"></td>
        </tr>
        {% endif %}

        <!-- Row 3: Ref Chantier AND Client Box -->
        <tr>
            <td style="width: 50%; vertical-align: top;">
                <strong>Référence Chantier :</strong> {{ document.chantier_reference if document.chantier_reference else
                '' }}
            </td>

            <td style="width: 50%; vertical-align: top;">
                <div class="client-box">
                    <strong style="font-size: 14px;">{{ document.client.raison_sociale }}</strong><br>
                    {{ document.client.adresse }}<br>
                    {{ document.client.code_postal }} {{ document.client.ville }}<br>
                    {% if document.client.tva_intra %}TVA Intra: {{ document.client.tva_intra }}<br>{% endif %}
                </div>

                <!-- Ville et Date -->
                <div class="city-date">
                    {{ info.ville_signature if info and info.ville_signature else 'MONTREUIL' }} le {{
                    document.date.strftime('%d/%m/%Y') }}
                </div>
            </td>
        </tr>
    </table>

    <!-- 2. Items Table -->
    <table class="items-table">
        <thead>
            <tr>
                <th style="width: 45%;">Désignation</th>
                <th style="width: 15%; text-align: right;">Qté</th>
                <th style="width: 20%; text-align: right;">Prix Unitaire HT</th>
                <th style="width: 20%; text-align: right;">Total HT</th>
            </tr>
        </thead>
        <tbody>
            {% for ligne in document.lignes %}
            <tr>
                <td>{{ ligne.designation }}</td>
                <td style="text-align: right;">{{ ligne.quantite }}</td>
                <td style="text-align: right;">{{ "%.2f"|format(ligne.prix_unitaire|default(0)) }} €</td>
                <td style="text-align: right;">{{ "%.2f"|format(ligne.total_ligne|default(0)) }} €</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- MENTION AUTO LIQUIDATION (ALWAYS VISIBLE) -->
    <div style="margin-top: 10px; font-style: italic; font-size: 10px; color: #000;">
        Auto liquidation de la TVA suivant CGI, Ann. II, art.242 Nonies A-I-13
    </div>

    <!-- TOTALS & CONDITIONS -->
    <div style="width: 100%; clear: both; margin-top: 20px;">
        <!-- CONDITIONS & IBAN (Float Left - Merged Box) -->
        <div style="float: left; width: 45%;">
            {% if (info and info.conditions_reglement) or (info and info.iban) %}
            <div class="bordered-box">
                {% if info.conditions_reglement %}
                <strong>Conditions de règlement :</strong> {{ info.conditions_reglement|replace('\n', ' ')|safe }}
                {% endif %}

                {% if info.conditions_reglement and info.iban %}
                &nbsp; - &nbsp;
                {% endif %}

                {% if info.iban %}
                <strong>IBAN :</strong> {{ info.iban }}
                {% endif %}
            </div>
            {% endif %}
        </div>

        <!-- TOTALS (Float Right) -->
        <div style="float: right; width: 40%; background-color: #f9f9f9; padding: 10px; border-radius: 5px;">
            <div class="totals-row clearfix">
                <span style="float: left;">Total HT :</span>
                <span style="float: right;">{{ "%.2f"|format(document.montant_ht|default(0)) }} €</span>
            </div>
            {% if document.autoliquidation %}
            <div class="totals-row clearfix" style="color: #000;">
                <span style="float: left;">TVA (Autoliquidation) :</span>
                <span style="float: right;">0.00 €</span>
            </div>
            {% else %}
            <div class="totals-row clearfix">
                <span style="float: left;">TVA (20%) :</span>
                <span style="float: right;">{{ "%.2f"|format(document.tva|default(0)) }} €</span>
            </div>
            {% endif %}
            <div class="totals-row grand-total clearfix">
                <span style="float: left;">{% if document.autoliquidation %}Net à Payer (HT) :{% else %}Net à Payer :{%
                    endif %}</span>
                <span style="float: right;">{{ "%.2f"|format(document.montant_ttc|default(0)) }} €</span>
            </div>
        </div>
    </div>
</body>

</html>