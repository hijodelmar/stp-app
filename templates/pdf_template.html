<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>{{ document.numero }}</title>
    <style>
        body {
            font-family: Helvetica, Arial, sans-serif;
            font-size: 12px;
            color: #333;
        }

        /* Layout structure using Tables for reliability in xhtml2pdf */
        table.layout-table {
            width: 100%;
            border: none;
            border-collapse: collapse;
        }

        table.layout-table td {
            border: none;
            vertical-align: top;
        }

        /* Items Table */
        table.items-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 30px;
        }

        table.items-table th {
            border-bottom: 2px solid #333;
            color: #333;
            text-align: left;
            padding: 10px;
            font-weight: bold;
        }

        table.items-table td {
            border-bottom: 1px solid #eee;
            padding: 10px;
        }

        .totals {
            margin-top: 30px;
            float: right;
            width: 40%;
        }

        .totals-row {
            margin-bottom: 5px;
            font-size: 13px;
        }

        .totals-row.grand-total {
            font-weight: bold;
            font-size: 16px;
            color: #005c97;
            border-top: 2px solid #005c97;
            padding-top: 10px;
        }

        .footer {
            position: fixed;
            bottom: 0;
            width: 100%;
            text-align: center;
            font-size: 9px;
            color: #999;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }
    </style>
</head>

<body>
    <!-- HEADER : 3 Columns (Logo | Company Info | Client Info) -->
    <div class="header" style="margin-bottom: 30px;">
        <table class="layout-table">
            <tr>
                <!-- 1. Logo (Fixed Size) -->
                <td style="width: 150px; padding-right: 15px;">
                    {% if info and info.logo_path %}
                    <!-- Ajout d'une largeur explicite pour éviter les erreurs de calcul xhtml2pdf -->
                    <img src="d:/websites/stp/static/{{ info.logo_path }}" width="150"
                        style="width: 150px; height: auto;">
                    {% endif %}
                </td>

                <!-- 2. Company Info -->
                <td style="text-align: left;">
                    <p style="margin: 0; font-size: 11px; line-height: 1.3; color: #555;">
                        <strong style="color: #333; font-size: 13px;">{{ info.nom if info else 'STP' }}</strong><br>
                        {{ info.adresse if info else '' }}<br>
                        {{ info.cp if info else '' }} {{ info.ville if info else '' }}<br>
                        Tél: {{ info.telephone if info else '' }}<br>
                        Email: {{ info.email if info else '' }}<br>
                    </p>
                </td>

                <!-- 3. Client Info (Right) -->
                <td style="text-align: right;">
                    <div
                        style="background-color: #fcfcfc; border: 1px solid #ddd; padding: 15px; border-radius: 4px; display: inline-block; width: 250px; text-align: left;">
                        <span style="color: #666; font-size: 9px; text-transform: uppercase;">Facturé à :</span><br>
                        <strong style="font-size: 13px;">{{ document.client.raison_sociale }}</strong><br>
                        <span style="font-size: 11px; color: #555;">
                            {{ document.client.adresse }}<br>
                            {{ document.client.code_postal }} {{ document.client.ville }}<br>
                            {% if document.client.tva_intra %}TVA Intra: {{ document.client.tva_intra }}<br>{% endif %}
                        </span>
                    </div>
                </td>
            </tr>
        </table>
    </div>

    <!-- DOCUMENT META -->
    <div
        style="clear: both; margin-top: 10px; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px;">
        <h2 style="margin: 0; color: #005c97;">{{ document.type|upper }} N° {{ document.numero }}</h2>
        {% if document.type == 'avoir' %}
        <p style="margin: 0; color: #666; font-size: 11px;">Sur facture N° {{ document.source_document.numero if
            document.source_document else '(Aucune facture liée)' }}</p>
        {% endif %}
        <p class="doc-meta" style="margin: 5px 0 0 0; color: #666;">
            Date d'émission : <strong>{{ document.date.strftime('%d/%m/%Y') }}</strong>
            {% if info and info.ville_signature %} à {{ info.ville_signature }}{% endif %}
        </p>
    </div>

    <!-- ITEMS TABLE -->
    <table class="items-table">
        <thead>
            <tr>
                <th style="width: 45%;">Désignation</th>
                <th style="width: 15%; text-align: right;">Qté</th>
                <th style="width: 20%; text-align: right;">Prix Unitaire HT</th>
                <th style="width: 20%; text-align: right;">Total HT</th>
            </tr>
        </thead>
        <tbody>
            {% for ligne in document.lignes %}
            <tr>
                <td>{{ ligne.designation }}</td>
                <td style="text-align: right;">{{ ligne.quantite }}</td>
                <td style="text-align: right;">{{ "%.2f"|format(ligne.prix_unitaire|default(0)) }} €</td>
                <td style="text-align: right;">{{ "%.2f"|format(ligne.total_ligne|default(0)) }} €</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- TOTALS -->
    <div class="clearfix" style="margin-top: 20px;">
        <div class="totals" style="background-color: #f9f9f9; padding: 20px; border-radius: 5px;">
            <div class="totals-row clearfix">
                <span style="float: left;">Total HT :</span>
                <span style="float: right;">{{ "%.2f"|format(document.montant_ht|default(0)) }} €</span>
            </div>
            {% if document.autoliquidation %}
            <div class="totals-row clearfix" style="color: #666;">
                <span style="float: left;">TVA (Autoliquidation) :</span>
                <span style="float: right;">0.00 €</span>
            </div>
            {% else %}
            <div class="totals-row clearfix">
                <span style="float: left;">TVA (20%) :</span>
                <span style="float: right;">{{ "%.2f"|format(document.tva|default(0)) }} €</span>
            </div>
            {% endif %}
            <div class="totals-row grand-total clearfix">
                <span style="float: left;">Net à Payer :</span>
                <span style="float: right;">{{ "%.2f"|format(document.montant_ttc|default(0)) }} €</span>
            </div>

            <div style="margin-top: 15px; font-style: italic; font-size: 10px; text-align: right; color: #555;">
                Auto liquidation de la TVA suivant CGI, Ann. II, art.242 Nonies A-I-13
            </div>
        </div>
    </div>

    <!-- CONDITIONS BOX -->
    <!-- CONDITIONS BOX -->
    <div
        style="clear: both; margin-top: 30px; font-size: 11px; border: 1px solid #999; padding: 10px; border-radius: 5px;">
        {% if info and info.conditions_reglement %}
        <p><strong>Conditions de règlement :</strong> {{ info.conditions_reglement|replace('\n', '<br>')|safe }}</p>
        {% endif %}

        {% if info and info.iban %}
        <p style="margin-top: 10px;">
            <strong>(IBAN):</strong> {{ info.iban }}
        </p>
        {% endif %}
    </div>

    <!-- SIGNATURE BLOCK (Specific to Devis) -->
    {% if document.type == 'devis' %}
    <div style="margin-top: 40px; page-break-inside: avoid;">
        <div style="float: left; width: 40%;">
            <strong>Bon pour accord</strong><br>
            <span style="font-size: 10px; color: #666;">(Date et Signature précédées de la mention "Bon pour
                accord")</span>
            <div style="height: 100px; border: 1px solid #ccc; margin-top: 10px;"></div>
        </div>
        <div style="float: right; width: 40%; text-align: right;">
            <strong>Date :</strong> ........................................
        </div>
        <div style="clear: both;"></div>
    </div>
    {% endif %}



    <!-- FOOTER -->
    <div class="footer">
        {% if info and info.footer_info %}
        {{ info.footer_info|replace('\n', '<br>')|safe }}
        {% else %}
        Service Température et Plomberie
        {% endif %}
    </div>
</body>

</html>